import{u as L,b as K,c as q,r as s,y as c,a as I,A as $,j as a}from"./index-BfVn0bv8.js";const z=()=>{const u=L(),R=K(),{loginBuyer:P}=q(),{mobileNumber:l,token:d,autootp:E}=R.state||{},[p,y]=s.useState(["","","",""]),[O,C]=s.useState(E||""),[i,m]=s.useState(!1),[h,w]=s.useState(!1),[g,N]=s.useState(30),[V,v]=s.useState(0),b=s.useRef(!1),x=s.useRef(Date.now()),r=s.useRef(null),f=s.useRef(!1);s.useEffect(()=>{(!l||!d)&&(c.error("Invalid session. Please login again."),u("/buyer/login"))},[l,d,u]),s.useEffect(()=>{if(f.current)return;const e=()=>{if(f.current){r.current&&clearInterval(r.current);return}const t=Date.now()-x.current,n=300*1e3;if(t>=n){r.current&&clearInterval(r.current),c.error("OTP has expired. Please request a new one."),u("/buyer/login");return}};return r.current=setInterval(e,1e3),()=>{r.current&&clearInterval(r.current)}},[u]),s.useEffect(()=>{if(g>0){const e=setTimeout(()=>N(g-1),1e3);return()=>clearTimeout(e)}else w(!0)},[g]);const k=(e,t)=>{if(t&&!/^\d$/.test(t))return;const n=[...p];if(n[e]=t,y(n),t&&e<3){const o=document.getElementById(`buyer-otp-${e+1}`);o&&o.focus()}},S=(e,t)=>{if(t.key==="Backspace"&&!p[e]&&e>0){const n=document.getElementById(`buyer-otp-${e-1}`);n&&n.focus()}},j=s.useCallback(async(e=p.join(""))=>{if(e.length!==4){c.error("Please enter a 4-digit OTP");return}if(f.current)return;const t=Date.now()-x.current,n=300*1e3;if(t>=n){r.current&&(clearInterval(r.current),r.current=null),c.error("OTP has expired. Please request a new one."),u("/buyer/login");return}if(!(b.current||i)){b.current=!0,m(!0);try{console.log("Verifying OTP:",e,"for phone:",l);const o=await I.post(`${$}/api/auth/verify-otp`,{mobileNumber:l,otp:e},{headers:{Authorization:`Bearer ${d}`,"Content-Type":"application/json"}});console.log("Verification response:",o.data),o.status===200&&o.data.token?(f.current=!0,r.current&&(clearInterval(r.current),r.current=null),c.success("OTP verified successfully!"),P(o.data.token),u("/buyer/dashboard")):(c.error(o.data.message||"OTP verification failed"),y(["","","",""]),v(T=>T+1))}catch(o){console.error("Verification error:",o);const T=o.response?.data?.message||o.message;T.toLowerCase().includes("expired")?(r.current&&(clearInterval(r.current),r.current=null),c.error("OTP has expired. Please request a new one."),setTimeout(()=>{u("/buyer/login")},2e3)):c.error(T),y(["","","",""]),v(A=>A+1)}finally{m(!1),b.current=!1}}},[p,l,d,i,P,u]);s.useEffect(()=>{const e=p.join("");e.length===4&&!i&&!b.current&&j(e)},[p,j,i]);const B=async()=>{if(h)try{m(!0);const e=await I.post(`${$}/api/auth/login`,{mobileNumber:l},{headers:{"Content-Type":"application/json"}});x.current=Date.now(),f.current=!1,y(["","","",""]),v(t=>t+1),w(!1),N(30),e.data.otp&&C(e.data.otp),c.success(`New OTP sent! OTP: ${e.data.otp}`)}catch(e){const t=e.response?.data?.message||e.message;c.error(t)}finally{m(!1)}},D=l?`+91 ******${l.slice(-3)}`:"";return a.jsxs("div",{className:"buyer-otp-verification-container",children:[i&&a.jsx("div",{className:"buyer-otp-loader",children:a.jsx("div",{className:"buyer-otp-spinner"})}),a.jsxs("div",{className:`buyer-otp-verification-content ${i?"blurred":""}`,children:[O&&a.jsxs("div",{className:"buyer-otp-display",children:[a.jsx("p",{className:"buyer-otp-display-label",children:"Your OTP Code:"}),a.jsx("div",{className:"buyer-otp-display-code",children:O})]}),a.jsx("h2",{className:"buyer-otp-title",children:"Verification code"}),a.jsxs("p",{className:"buyer-otp-subtitle",children:["Enter the 4-digit code sent to ",D]}),a.jsx("div",{className:"buyer-otp-inputs",children:p.map((e,t)=>a.jsx("input",{id:`buyer-otp-${t}`,type:"text",className:`buyer-otp-input ${e?"filled":""}`,maxLength:1,value:e,onChange:n=>k(t,n.target.value),onKeyDown:n=>S(t,n),disabled:i,autoFocus:t===0},t))},V),a.jsx("button",{className:`buyer-otp-verify ${i?"disabled":""}`,onClick:()=>j(),disabled:i||p.join("").length!==4,children:i?"Verifying...":"Verify OTP"}),a.jsx("button",{className:`buyer-otp-resend ${h?"":"disabled"}`,onClick:B,disabled:!h||i,children:h?"Resend OTP":`Resend in ${g}s`})]})]})};export{z as default};
